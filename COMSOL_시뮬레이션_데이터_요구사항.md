# 림프칩 PINN 고정확도 모델을 위한 COMSOL 시뮬레이션 데이터 요구사항

> **작성일**: 2026-01-26
> **목적**: AI 대리 모델의 신뢰 가능한 정확도 확보를 위한 시뮬레이션 데이터 설계

---

## 목차

1. [현재 데이터 한계 요약](#1-현재-데이터-한계-요약)
2. [목표 정확도 및 필요 데이터 규모](#2-목표-정확도-및-필요-데이터-규모)
3. [파라미터 샘플링 전략](#3-파라미터-샘플링-전략)
4. [시뮬레이션 케이스 설계](#4-시뮬레이션-케이스-설계)
5. [추출해야 할 데이터 필드](#5-추출해야-할-데이터-필드)
6. [COMSOL 시뮬레이션 설정](#6-comsol-시뮬레이션-설정)
7. [데이터 형식 및 파일 구조](#7-데이터-형식-및-파일-구조)
8. [검증 데이터 전략](#8-검증-데이터-전략)
9. [우선순위별 실행 계획](#9-우선순위별-실행-계획)
10. [예상 효과 및 정확도](#10-예상-효과-및-정확도)

---

## 1. 현재 데이터 한계 요약

### 1.1 현재 데이터 현황

```
┌─────────────────────────────────────────────────────────────────┐
│                      현재 데이터 구조                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  총 케이스: 24개                                                │
│  ├── Injection site: 12개 (단일 파라미터 변화)                  │
│  └── sol765: 12개 (kdecay만 변화)                               │
│                                                                 │
│  파라미터 공간: 6차원                                           │
│  가능한 조합 (3수준): 3⁶ = 729개                                │
│  현재 커버리지: 24/729 = 3.3%                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 문제점

| 문제 | 현재 상황 | 영향 |
|------|----------|------|
| **단일 파라미터 변화** | 한 번에 1개만 변경 | 상호작용 효과 학습 불가 |
| **불균등 분포** | Mid 값 중심 | 범위 전체 학습 불가 |
| **kdecay 분리** | 별도 파일 | 다른 파라미터와 조합 없음 |
| **공간 정보 부재** | 구획 평균만 | 물리 방정식 검증 불가 |

### 1.3 이로 인한 모델 한계

```
현재 모델 예측 오차:
├── 기존 케이스와 동일: ~0%
├── 단일 파라미터 보간: 5-10%
├── 2개 파라미터 조합: 15-30% ⚠️
├── 3개 이상 조합: 30%+ ⚠️
└── 범위 외: 불확실 ❌
```

---

## 2. 목표 정확도 및 필요 데이터 규모

### 2.1 목표 정확도

```
┌─────────────────────────────────────────────────────────────────┐
│                      목표 정확도 설정                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Tier 1 (연구/스크리닝 용도):                                   │
│  ├── 모든 파라미터 조합에서 오차 < 10%                          │
│  ├── 필요 케이스: 약 100-150개                                  │
│  └── 신뢰도: 정성적 경향성 파악 가능                            │
│                                                                 │
│  Tier 2 (정량적 예측 용도):                                     │
│  ├── 모든 파라미터 조합에서 오차 < 5%                           │
│  ├── 필요 케이스: 약 200-300개                                  │
│  └── 신뢰도: 정량적 의사결정 가능                               │
│                                                                 │
│  Tier 3 (임상/산업 적용):                                       │
│  ├── 모든 파라미터 조합에서 오차 < 3%                           │
│  ├── 필요 케이스: 약 500개 이상                                 │
│  └── 신뢰도: 규제 수준 신뢰도                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 데이터 규모 산정 근거

```python
# 경험적 규칙: 차원당 5-10개 포인트 필요
param_dimensions = 6
points_per_dim = 7  # Low, Mid-Low, Mid, Mid-High, High + 2개 추가

# 전체 격자 샘플링 (Full Factorial)
full_factorial = 7 ** 6 = 117,649  # 비현실적

# Latin Hypercube Sampling (효율적)
# 일반적으로 10 × 차원 수 ~ 50 × 차원 수
lhs_minimum = 10 * 6 = 60
lhs_recommended = 30 * 6 = 180
lhs_comprehensive = 50 * 6 = 300

# 권장: 200개 케이스 (Tier 2 목표)
```

### 2.3 데이터 규모별 예상 정확도

| 케이스 수 | 커버리지 | 단일 파라미터 | 2개 조합 | 3개 조합 | 권장 용도 |
|-----------|----------|--------------|----------|----------|-----------|
| 24 (현재) | 3% | 5-10% | 15-30% | 30%+ | 경향성만 |
| 100 | 14% | 3-5% | 8-12% | 15-20% | 연구용 |
| **200** | **27%** | **2-4%** | **5-8%** | **10-15%** | **정량 예측** |
| 300 | 41% | 1-3% | 3-6% | 8-12% | 고정밀 |
| 500 | 69% | <2% | <4% | <8% | 임상/산업 |

---

## 3. 파라미터 샘플링 전략

### 3.1 파라미터 범위 정의

```
┌─────────────────────────────────────────────────────────────────┐
│                     파라미터 범위 (5수준)                        │
├────────────┬──────────┬──────────┬──────────┬──────────┬───────┤
│ 파라미터    │ Very Low │   Low    │   Mid    │   High   │V.High │
├────────────┼──────────┼──────────┼──────────┼──────────┼───────┤
│ Lp_ve      │ 2e-12    │ 4e-12    │ 8e-12    │ 1.6e-11  │3.2e-11│
│ (m/Pa·s)   │          │          │          │          │       │
├────────────┼──────────┼──────────┼──────────┼──────────┼───────┤
│ K          │ 1e-18    │ 1e-17    │ 1e-15    │ 1e-13    │1e-12  │
│ (m²)       │          │          │          │          │       │
├────────────┼──────────┼──────────┼──────────┼──────────┼───────┤
│ P_oncotic  │ 2900     │ 3145     │ 3590     │ 3815     │4100   │
│ (Pa)       │          │          │          │          │       │
├────────────┼──────────┼──────────┼──────────┼──────────┼───────┤
│ sigma_ve   │ 0.05     │ 0.1      │ 0.5      │ 0.9      │0.95   │
│ (-)        │          │          │          │          │       │
├────────────┼──────────┼──────────┼──────────┼──────────┼───────┤
│ D_gel      │ 5e-12    │ 1e-11    │ 3e-11    │ 1e-10    │3e-10  │
│ (m²/s)     │          │          │          │          │       │
├────────────┼──────────┼──────────┼──────────┼──────────┼───────┤
│ kdecay     │ 0        │ 2.9e-7   │ 1.7e-6   │ 1.5e-5   │1e-4   │
│ (1/s)      │          │          │          │          │       │
└────────────┴──────────┴──────────┴──────────┴──────────┴───────┘
```

### 3.2 Latin Hypercube Sampling (LHS) 전략

```python
"""
Latin Hypercube Sampling 생성 코드
"""
from scipy.stats import qmc
import numpy as np

def generate_lhs_samples(n_samples=200, seed=42):
    """
    6차원 파라미터 공간에서 LHS 샘플 생성

    Returns:
        samples: (n_samples, 6) 정규화된 샘플 [0, 1]
        params: (n_samples, 6) 실제 파라미터 값
    """

    # LHS 샘플러
    sampler = qmc.LatinHypercube(d=6, seed=seed)
    samples = sampler.random(n=n_samples)  # [0, 1] 범위

    # 파라미터 범위 (로그/선형 스케일 고려)
    param_ranges = {
        'Lp_ve': (2e-12, 3.2e-11, 'log'),
        'K': (1e-18, 1e-12, 'log'),
        'P_oncotic': (2900, 4100, 'linear'),
        'sigma_ve': (0.05, 0.95, 'linear'),
        'D_gel': (5e-12, 3e-10, 'log'),
        'kdecay': (0, 1e-4, 'log_zero'),  # 0 포함
    }

    params = np.zeros((n_samples, 6))
    param_names = list(param_ranges.keys())

    for i, (name, (low, high, scale)) in enumerate(param_ranges.items()):
        if scale == 'log':
            # 로그 스케일 변환
            log_low, log_high = np.log10(low), np.log10(high)
            params[:, i] = 10 ** (log_low + samples[:, i] * (log_high - log_low))
        elif scale == 'log_zero':
            # 0 포함 로그 스케일 (10%는 0으로)
            zero_mask = samples[:, i] < 0.1
            params[zero_mask, i] = 0
            params[~zero_mask, i] = 10 ** (np.log10(1e-8) +
                                           (samples[~zero_mask, i] - 0.1) / 0.9 *
                                           (np.log10(high) - np.log10(1e-8)))
        else:
            # 선형 스케일
            params[:, i] = low + samples[:, i] * (high - low)

    return samples, params, param_names

# 샘플 생성 예시
samples, params, names = generate_lhs_samples(200)
print(f"생성된 샘플 수: {len(params)}")
```

### 3.3 샘플링 계층 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                   권장 샘플링 구조 (200개)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Layer 1: 기준점 및 경계 (30개)                                 │
│  ───────────────────────────────                                │
│  • 모든 파라미터 Mid: 1개                                       │
│  • 각 파라미터 극값 (다른 파라미터 Mid): 12개                   │
│  • 코너 포인트 (모든 파라미터 Low 또는 High): 17개              │
│                                                                 │
│  Layer 2: 2-파라미터 상호작용 (60개)                            │
│  ───────────────────────────────                                │
│  • 15개 파라미터 조합 × 4개 수준 = 60개                         │
│  • 예: (Lp=High, K=High), (Lp=High, K=Low), ...                │
│                                                                 │
│  Layer 3: LHS 공간 채우기 (80개)                                │
│  ───────────────────────────────                                │
│  • Latin Hypercube Sampling으로 균등 분포                       │
│  • 파라미터 공간 전체를 균등하게 커버                           │
│                                                                 │
│  Layer 4: 검증용 홀드아웃 (30개)                                │
│  ───────────────────────────────                                │
│  • 학습에 사용하지 않는 검증 데이터                             │
│  • 모델 정확도 독립 검증용                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 시뮬레이션 케이스 설계

### 4.1 필수 케이스 목록

#### Layer 1: 기준점 및 경계 (30개)

```
┌─────────────────────────────────────────────────────────────────┐
│                    기준점 케이스 (1개)                           │
├─────────────────────────────────────────────────────────────────┤
│ Case_BASE: 모든 파라미터 = Mid                                  │
│   Lp_ve=8e-12, K=1e-15, P=3590, σ=0.5, D=3e-11, k=1.7e-6       │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                 단일 파라미터 극값 (12개)                        │
├─────────────────────────────────────────────────────────────────┤
│ Case_Lp_VL: Lp_ve=2e-12, 나머지 Mid                             │
│ Case_Lp_VH: Lp_ve=3.2e-11, 나머지 Mid                           │
│ Case_K_VL:  K=1e-18, 나머지 Mid                                 │
│ Case_K_VH:  K=1e-12, 나머지 Mid                                 │
│ Case_P_VL:  P_oncotic=2900, 나머지 Mid                          │
│ Case_P_VH:  P_oncotic=4100, 나머지 Mid                          │
│ Case_S_VL:  sigma_ve=0.05, 나머지 Mid                           │
│ Case_S_VH:  sigma_ve=0.95, 나머지 Mid                           │
│ Case_D_VL:  D_gel=5e-12, 나머지 Mid                             │
│ Case_D_VH:  D_gel=3e-10, 나머지 Mid                             │
│ Case_k_0:   kdecay=0, 나머지 Mid                                │
│ Case_k_VH:  kdecay=1e-4, 나머지 Mid                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    코너 포인트 (17개)                            │
├─────────────────────────────────────────────────────────────────┤
│ 모든 파라미터가 Low 또는 High 조합의 대표 샘플                   │
│ (2⁶ = 64개 중 물리적으로 의미 있는 17개 선택)                   │
│                                                                 │
│ Case_ALL_LOW:  모든 파라미터 = Low                              │
│ Case_ALL_HIGH: 모든 파라미터 = High                             │
│ Case_CORNER_1: Lp=H, K=H, P=L, σ=L, D=H, k=0                   │
│ Case_CORNER_2: Lp=L, K=H, P=H, σ=H, D=L, k=H                   │
│ ... (물리적 의미 있는 조합 선택)                                │
└─────────────────────────────────────────────────────────────────┘
```

#### Layer 2: 2-파라미터 상호작용 (60개)

```
┌─────────────────────────────────────────────────────────────────┐
│              2-파라미터 조합 매트릭스 (15개 조합)                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 조합 1: Lp_ve × K (가장 중요 - 유체 이동)                       │
│ ────────────────────────────────                                │
│   Case_LpK_HH: Lp=High, K=High, 나머지=Mid                      │
│   Case_LpK_HL: Lp=High, K=Low, 나머지=Mid                       │
│   Case_LpK_LH: Lp=Low, K=High, 나머지=Mid                       │
│   Case_LpK_LL: Lp=Low, K=Low, 나머지=Mid                        │
│                                                                 │
│ 조합 2: Lp_ve × sigma_ve (Starling 방정식)                      │
│ ────────────────────────────────                                │
│   Case_LpS_HH, Case_LpS_HL, Case_LpS_LH, Case_LpS_LL           │
│                                                                 │
│ 조합 3: Lp_ve × P_oncotic (Starling 방정식)                     │
│ ────────────────────────────────                                │
│   Case_LpP_HH, Case_LpP_HL, Case_LpP_LH, Case_LpP_LL           │
│                                                                 │
│ 조합 4: K × D_gel (확산-대류 결합)                              │
│ ────────────────────────────────                                │
│   Case_KD_HH, Case_KD_HL, Case_KD_LH, Case_KD_LL               │
│                                                                 │
│ 조합 5: sigma_ve × P_oncotic (삼투 효과)                        │
│ ────────────────────────────────                                │
│   Case_SP_HH, Case_SP_HL, Case_SP_LH, Case_SP_LL               │
│                                                                 │
│ ... (나머지 10개 조합도 동일 패턴)                              │
│                                                                 │
│ 총: 15개 조합 × 4개 수준 = 60개 케이스                          │
└─────────────────────────────────────────────────────────────────┘
```

#### Layer 3: LHS 공간 채우기 (80개)

```python
# LHS 샘플 생성 (Layer 1, 2와 중복 제거)
lhs_samples = generate_lhs_samples(100)  # 약간 여유있게 생성

# 기존 케이스와 거리 계산하여 중복 제거
unique_samples = remove_duplicates(lhs_samples, existing_cases, threshold=0.1)

# 최종 80개 선택
layer3_cases = unique_samples[:80]
```

#### Layer 4: 검증용 홀드아웃 (30개)

```
┌─────────────────────────────────────────────────────────────────┐
│                    검증 데이터 전략                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 목적: 모델 학습에 사용하지 않는 독립 검증 세트                  │
│                                                                 │
│ 구성:                                                           │
│ • 10개: Layer 1-3 포인트 근처 (보간 검증)                       │
│ • 10개: 파라미터 공간 중심부 (일반화 검증)                      │
│ • 10개: 경계 영역 (외삽 안정성 검증)                            │
│                                                                 │
│ 선택 기준:                                                      │
│ • 학습 데이터와 최소 거리 유지                                  │
│ • 파라미터 공간 균등 분포                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 케이스 ID 명명 규칙

```
케이스 ID 형식: {Layer}_{Type}_{Parameters}_{Index}

예시:
• L1_BASE_000        : Layer 1, 기준점
• L1_CORNER_ALL_LOW  : Layer 1, 코너, 모든 Low
• L2_PAIR_LpK_HH_001 : Layer 2, 2개 조합, Lp-K, High-High
• L3_LHS_042         : Layer 3, LHS 샘플 42번
• L4_VAL_015         : Layer 4, 검증용 15번
```

---

## 5. 추출해야 할 데이터 필드

### 5.1 필수 출력 데이터 (현재와 동일)

```
┌─────────────────────────────────────────────────────────────────┐
│                      구획별 약물 비율                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 시간 포인트: 0 ~ 72시간, 최소 100개 포인트                      │
│                                                                 │
│ 필수 컬럼:                                                      │
│ • time_hour: 시간 (h)                                          │
│ • Blood_pct: 혈액 구획 약물 비율 (%)                           │
│ • Lymph_pct: 림프 구획 약물 비율 (%)                           │
│ • ECM_pct: 세포외기질 약물 비율 (%)                            │
│ • Decay_pct: 분해된 약물 비율 (%)                              │
│ • Total_pct: 총합 (검증용, ~100%)                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 추가 권장 출력 데이터 (물리 PINN용)

```
┌─────────────────────────────────────────────────────────────────┐
│                    물리 기반 PINN을 위한 추가 데이터              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ A. 경계면 플럭스 데이터                                         │
│ ─────────────────────                                           │
│ • J_blood_ecm: 혈관→ECM 플럭스 (mol/m²/s)                      │
│ • J_ecm_lymph: ECM→림프관 플럭스 (mol/m²/s)                    │
│ • J_total_clearance: 총 제거율 (mol/s)                         │
│                                                                 │
│ B. 압력 데이터                                                  │
│ ─────────────────────                                           │
│ • P_blood: 혈관 내 압력 (Pa)                                   │
│ • P_ecm_avg: ECM 평균 압력 (Pa)                                │
│ • P_lymph: 림프관 압력 (Pa)                                    │
│ • delta_P: 압력 차이 (Pa)                                      │
│                                                                 │
│ C. 유속 데이터                                                  │
│ ─────────────────────                                           │
│ • v_interstitial_avg: ECM 내 평균 유속 (m/s)                   │
│ • v_max: 최대 유속 (m/s)                                       │
│                                                                 │
│ D. 농도 구배 데이터                                             │
│ ─────────────────────                                           │
│ • dC_dr_boundary: 경계면에서의 농도 구배 (mol/m³/m)            │
│ • C_max: 최대 농도 (mol/m³)                                    │
│ • C_min: 최소 농도 (mol/m³)                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 공간 분포 데이터 (선택적, 고급)

```
┌─────────────────────────────────────────────────────────────────┐
│                    3D 공간 분포 데이터 (선택적)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 목적: DeepONet 또는 고급 물리 PINN용                            │
│                                                                 │
│ 출력 형식:                                                      │
│ • 격자 해상도: 최소 50×50×20 포인트                             │
│ • 각 격자점: (x, y, z, t, C, P, v_x, v_y, v_z)                 │
│                                                                 │
│ 파일 크기 고려:                                                 │
│ • 케이스당 ~500MB (전체 시간, 전체 공간)                        │
│ • 선택적 시간 포인트만 저장 권장 (0, 12, 24, 48, 72h)          │
│                                                                 │
│ 우선순위: 낮음 (추후 확장용)                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4 메타데이터

```
┌─────────────────────────────────────────────────────────────────┐
│                      케이스별 메타데이터                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 필수 정보:                                                      │
│ • case_id: 케이스 고유 ID                                       │
│ • simulation_date: 시뮬레이션 실행 일시                         │
│ • comsol_version: COMSOL 버전                                  │
│ • mesh_elements: 메쉬 요소 수                                   │
│ • solver_time: 계산 시간 (s)                                   │
│ • convergence_status: 수렴 상태                                 │
│                                                                 │
│ 파라미터 정보:                                                  │
│ • Lp_ve: 값 + 단위                                             │
│ • K: 값 + 단위                                                 │
│ • P_oncotic: 값 + 단위                                         │
│ • sigma_ve: 값 + 단위                                          │
│ • D_gel: 값 + 단위                                             │
│ • kdecay: 값 + 단위                                            │
│                                                                 │
│ 기하학 정보:                                                    │
│ • chip_geometry: 칩 기하학 버전/타입                            │
│ • blood_vessel_diameter: 혈관 직경 (m)                         │
│ • lymph_vessel_diameter: 림프관 직경 (m)                       │
│ • ecm_thickness: ECM 두께 (m)                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. COMSOL 시뮬레이션 설정

### 6.1 물리 모듈 설정

```
┌─────────────────────────────────────────────────────────────────┐
│                    COMSOL 물리 모듈 권장 설정                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 1. Darcy's Law (dl) - 다공성 매질 유동                          │
│ ────────────────────────────────────────                        │
│    도메인: ECM 영역                                             │
│    설정:                                                        │
│    • 투과도 K: 파라미터 (1e-18 ~ 1e-12 m²)                     │
│    • 유체 점성도: 0.001 Pa·s (물 기준)                         │
│    • 다공도: 0.3 (ECM 특성)                                    │
│                                                                 │
│ 2. Transport of Diluted Species (tds) - 용질 수송               │
│ ────────────────────────────────────────                        │
│    도메인: 전체                                                 │
│    설정:                                                        │
│    • 확산 계수 D: 파라미터 (5e-12 ~ 3e-10 m²/s)               │
│    • 대류 속도: Darcy 속도장 연결                               │
│    • 반응항: -kdecay × C                                       │
│                                                                 │
│ 3. Fluid-Structure Interaction 경계 조건                        │
│ ────────────────────────────────────────                        │
│    혈관-ECM 경계:                                               │
│    • Starling 방정식 적용                                       │
│    • Lp, sigma, P_oncotic 파라미터 반영                        │
│                                                                 │
│    ECM-림프관 경계:                                             │
│    • 림프 흡수 경계 조건                                        │
│    • 압력 기반 유입                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 메쉬 설정

```
┌─────────────────────────────────────────────────────────────────┐
│                        메쉬 권장 설정                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 목표: 정확도와 계산 시간의 균형                                 │
│                                                                 │
│ 권장 메쉬:                                                      │
│ • 유형: Free Tetrahedral (3D) 또는 Free Triangular (2D)        │
│ • 최소 요소 크기: 혈관 직경의 1/10                              │
│ • 최대 요소 크기: ECM 두께의 1/5                                │
│ • 경계층 메쉬: 혈관/림프관 벽면에 5-8층                         │
│                                                                 │
│ 메쉬 세분화:                                                    │
│ • 혈관 벽면: Fine                                               │
│ • ECM 중심: Normal                                              │
│ • 림프관 벽면: Fine                                             │
│                                                                 │
│ 예상 요소 수: 50,000 ~ 200,000                                  │
│ 예상 계산 시간: 10분 ~ 2시간 (파라미터에 따라)                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 시간 솔버 설정

```
┌─────────────────────────────────────────────────────────────────┐
│                      시간 솔버 권장 설정                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 시뮬레이션 시간:                                                │
│ • 시작: 0 h                                                     │
│ • 종료: 72 h (또는 정상 상태 도달 시)                           │
│                                                                 │
│ 시간 스테핑:                                                    │
│ • 방법: BDF (Backward Differentiation Formula)                 │
│ • 최대 차수: 2                                                  │
│ • 초기 시간 스텝: 0.01 h                                        │
│ • 최대 시간 스텝: 1 h                                           │
│                                                                 │
│ 출력 시간:                                                      │
│ • 옵션 1: 균등 간격 (0.72h마다, 100개 포인트)                   │
│ • 옵션 2: 로그 간격 (초기 밀집, 후기 희소)                      │
│                                                                 │
│ 권장 출력 시간 (로그 간격):                                     │
│   0, 0.1, 0.2, 0.5, 1, 2, 4, 6, 8, 10, 12, 16, 20, 24,        │
│   30, 36, 42, 48, 54, 60, 66, 72 h                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.4 수렴 기준

```
┌─────────────────────────────────────────────────────────────────┐
│                        수렴 기준 설정                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 상대 허용 오차: 1e-4                                            │
│ 절대 허용 오차: 1e-6                                            │
│                                                                 │
│ 질량 보존 검증:                                                 │
│ • 총 질량 변화 < 1%                                            │
│ • 각 시간 스텝에서 확인                                         │
│                                                                 │
│ 비수렴 처리:                                                    │
│ • 시간 스텝 자동 조절 활성화                                    │
│ • 최대 반복 횟수: 100                                           │
│ • 비수렴 시 케이스 로그 기록                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 데이터 형식 및 파일 구조

### 7.1 권장 폴더 구조

```
simulation_data/
│
├── metadata/
│   ├── parameter_matrix.csv       # 전체 파라미터 매트릭스
│   ├── case_list.json            # 케이스 목록 및 상태
│   └── simulation_config.yaml    # COMSOL 설정 기록
│
├── raw/                          # 원본 COMSOL 출력
│   ├── L1_BASE_000/
│   │   ├── compartment_ratios.csv
│   │   ├── boundary_fluxes.csv   # (선택적)
│   │   └── metadata.json
│   ├── L1_CORNER_ALL_LOW/
│   │   └── ...
│   └── ...
│
├── processed/                    # 전처리된 데이터
│   ├── train_data.pkl           # 학습용 (170개)
│   ├── validation_data.pkl      # 검증용 (30개)
│   └── normalization_params.json # 정규화 파라미터
│
└── validation/                   # 검증 결과
    ├── cross_validation/
    ├── holdout_test/
    └── error_analysis/
```

### 7.2 파일 형식 상세

#### parameter_matrix.csv

```csv
case_id,layer,Lp_ve,K,P_oncotic,sigma_ve,D_gel,kdecay,status,simulation_time
L1_BASE_000,1,8e-12,1e-15,3590,0.5,3e-11,1.7e-6,completed,1234.5
L1_CORNER_ALL_LOW,1,2e-12,1e-18,2900,0.05,5e-12,0,completed,2345.6
L2_PAIR_LpK_HH_001,2,3.2e-11,1e-12,3590,0.5,3e-11,1.7e-6,completed,3456.7
...
```

#### compartment_ratios.csv (케이스별)

```csv
time_hour,Blood_pct,Lymph_pct,ECM_pct,Decay_pct,Total_pct
0.00,0.00,0.20,99.80,0.00,100.00
0.10,0.05,0.35,99.50,0.10,100.00
0.20,0.12,0.52,99.20,0.16,100.00
...
72.00,18.40,47.90,33.70,0.00,100.00
```

#### metadata.json (케이스별)

```json
{
  "case_id": "L1_BASE_000",
  "layer": 1,
  "parameters": {
    "Lp_ve": {"value": 8e-12, "unit": "m/(Pa·s)"},
    "K": {"value": 1e-15, "unit": "m²"},
    "P_oncotic": {"value": 3590, "unit": "Pa"},
    "sigma_ve": {"value": 0.5, "unit": "-"},
    "D_gel": {"value": 3e-11, "unit": "m²/s"},
    "kdecay": {"value": 1.7e-6, "unit": "1/s"}
  },
  "simulation": {
    "comsol_version": "6.1",
    "date": "2026-01-26T10:30:00",
    "mesh_elements": 125000,
    "solver_time_seconds": 1234.5,
    "convergence": true,
    "mass_balance_error": 0.003
  },
  "geometry": {
    "type": "standard_lymphchip_v2",
    "blood_vessel_diameter_um": 100,
    "lymph_vessel_diameter_um": 50,
    "ecm_thickness_um": 200
  }
}
```

### 7.3 데이터 품질 검증 체크리스트

```
┌─────────────────────────────────────────────────────────────────┐
│                    데이터 품질 검증 항목                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ □ 질량 보존: |Blood + Lymph + ECM + Decay - 100| < 1%          │
│ □ 시간 연속성: 시간 역행 없음                                   │
│ □ 비음수: 모든 비율 ≥ 0                                        │
│ □ 초기 조건: t=0에서 ECM ≈ 100%                                │
│ □ 수렴 상태: COMSOL 수렴 플래그 확인                           │
│ □ 이상치: ±3σ 이상 값 플래그                                   │
│ □ 완전성: 72시간까지 모든 시간 포인트 존재                      │
│ □ 단조성: 일반적으로 Blood↑, Lymph↑, ECM↓                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 검증 데이터 전략

### 8.1 교차 검증 설계

```
┌─────────────────────────────────────────────────────────────────┐
│                   K-Fold 교차 검증 전략                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 방법: 5-Fold Cross-Validation                                   │
│                                                                 │
│ 학습 데이터 (170개) 분할:                                       │
│ • Fold 1: Train 136개, Val 34개                                │
│ • Fold 2: Train 136개, Val 34개                                │
│ • ...                                                           │
│ • Fold 5: Train 136개, Val 34개                                │
│                                                                 │
│ 분할 기준:                                                      │
│ • 층화 샘플링 (Layer 1-3 비율 유지)                            │
│ • 파라미터 공간 균등 분포                                       │
│                                                                 │
│ 평가 지표:                                                      │
│ • 평균 RMSE ± 표준편차                                         │
│ • 평균 R² ± 표준편차                                           │
│ • 최대 오차 케이스 분석                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 홀드아웃 검증 (Layer 4)

```
┌─────────────────────────────────────────────────────────────────┐
│                    독립 검증 세트 구성                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 30개 홀드아웃 케이스:                                           │
│                                                                 │
│ Group A: 보간 영역 검증 (10개)                                  │
│ ─────────────────────────────                                   │
│ • 학습 케이스 사이의 중간 파라미터                              │
│ • 예: Lp_ve = 6e-12 (Low와 Mid 사이)                           │
│ • 목적: 보간 정확도 검증                                        │
│                                                                 │
│ Group B: 일반화 검증 (10개)                                     │
│ ─────────────────────────────                                   │
│ • 파라미터 공간 중심부의 무작위 샘플                            │
│ • 학습 데이터와 일정 거리 이상                                  │
│ • 목적: 모델 일반화 능력 검증                                   │
│                                                                 │
│ Group C: 외삽 안정성 검증 (10개)                                │
│ ─────────────────────────────                                   │
│ • 파라미터 범위 경계 근처                                       │
│ • Very Low, Very High 영역 포함                                │
│ • 목적: 범위 외 예측 안정성 검증                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.3 검증 성공 기준

```
┌─────────────────────────────────────────────────────────────────┐
│                      목표 검증 지표                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Tier 2 목표 (정량 예측):                                        │
│ ─────────────────────────                                       │
│ • 전체 RMSE < 5%                                               │
│ • 전체 R² > 0.95                                               │
│ • 2-파라미터 조합 RMSE < 8%                                    │
│ • 3-파라미터 조합 RMSE < 15%                                   │
│ • 최대 오차 < 20%                                              │
│                                                                 │
│ 성분별 기준:                                                    │
│ ─────────────────────────                                       │
│ • Blood RMSE < 5%                                              │
│ • Lymph RMSE < 5%                                              │
│ • ECM RMSE < 5%                                                │
│ • Decay RMSE < 3% (kdecay > 0인 경우)                          │
│                                                                 │
│ 시간대별 기준:                                                  │
│ ─────────────────────────                                       │
│ • 초기 (0-12h) RMSE < 3%                                       │
│ • 중기 (12-48h) RMSE < 5%                                      │
│ • 후기 (48-72h) RMSE < 5%                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 우선순위별 실행 계획

### 9.1 Phase 1: 핵심 데이터 (1-2주)

```
┌─────────────────────────────────────────────────────────────────┐
│                    Phase 1: 필수 케이스 (50개)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 목표: 즉각적인 모델 개선                                        │
│ 소요 시간: ~50시간 (케이스당 1시간 가정)                        │
│                                                                 │
│ 케이스 구성:                                                    │
│ • Layer 1 기준점 및 극값: 13개                                  │
│ • Layer 2 핵심 2-파라미터 조합: 32개                            │
│   - Lp × K: 4개                                                │
│   - Lp × sigma: 4개                                            │
│   - Lp × P_oncotic: 4개                                        │
│   - K × D_gel: 4개                                             │
│   - sigma × P_oncotic: 4개                                     │
│   - Lp × kdecay: 4개                                           │
│   - K × kdecay: 4개                                            │
│   - D_gel × kdecay: 4개                                        │
│ • 검증용: 5개                                                   │
│                                                                 │
│ 예상 효과:                                                      │
│ • 2-파라미터 조합 오차: 30% → 12%                              │
│ • 전체 RMSE: 15% → 8%                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Phase 2: 확장 데이터 (2-4주)

```
┌─────────────────────────────────────────────────────────────────┐
│                   Phase 2: 확장 케이스 (100개)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 목표: Tier 2 정확도 달성                                        │
│ 소요 시간: ~100시간                                             │
│                                                                 │
│ 케이스 구성:                                                    │
│ • 나머지 2-파라미터 조합: 28개                                  │
│ • 코너 포인트: 17개                                             │
│ • LHS 공간 채우기: 40개                                         │
│ • 추가 검증용: 15개                                             │
│                                                                 │
│ 예상 효과:                                                      │
│ • 2-파라미터 조합 오차: 12% → 6%                               │
│ • 3-파라미터 조합 오차: 25% → 12%                              │
│ • 전체 RMSE: 8% → 5%                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.3 Phase 3: 고정밀 데이터 (4-8주)

```
┌─────────────────────────────────────────────────────────────────┐
│                   Phase 3: 고정밀 케이스 (50개)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 목표: 잔여 오차 최소화                                          │
│ 소요 시간: ~50시간                                              │
│                                                                 │
│ 케이스 구성:                                                    │
│ • 3-파라미터 핵심 조합: 20개                                    │
│ • 오차 높은 영역 추가 샘플: 20개 (Phase 2 분석 후 결정)         │
│ • 최종 검증용: 10개                                             │
│                                                                 │
│ 예상 효과:                                                      │
│ • 3-파라미터 조합 오차: 12% → 8%                               │
│ • 전체 RMSE: 5% → 3-4%                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.4 전체 일정 요약

```
┌─────────────────────────────────────────────────────────────────┐
│                       실행 타임라인                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Week 1-2:  Phase 1 시뮬레이션 (50개)                            │
│ Week 2-3:  Phase 1 데이터 통합 + 모델 재학습                    │
│ Week 3-6:  Phase 2 시뮬레이션 (100개)                           │
│ Week 6-7:  Phase 2 데이터 통합 + 모델 재학습 + 오차 분석        │
│ Week 7-10: Phase 3 시뮬레이션 (50개)                            │
│ Week 10-11: 최종 모델 학습 + 검증                               │
│ Week 11-12: 문서화 + 배포                                       │
│                                                                 │
│ 총 소요: 약 10-12주                                             │
│ 총 시뮬레이션: 200개                                            │
│ 총 계산 시간: ~200시간 (병렬 처리 시 단축 가능)                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 예상 효과 및 정확도

### 10.1 데이터 규모별 예상 정확도

```
┌─────────────────────────────────────────────────────────────────┐
│                    예상 정확도 개선 곡선                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  RMSE(%)                                                        │
│    30 │ ●                                                       │
│       │  ╲                                                      │
│    25 │   ╲                                                     │
│       │    ╲                                                    │
│    20 │     ╲                                                   │
│       │      ╲                                                  │
│    15 │       ●───────  (현재: 24개)                            │
│       │        ╲                                                │
│    10 │         ●─────  (Phase 1: 74개)                         │
│       │          ╲                                              │
│     5 │           ●───  (Phase 2: 174개)                        │
│       │            ╲                                            │
│     3 │             ●─  (Phase 3: 224개)                        │
│       │                                                         │
│     0 └──────────────────────────────────────────────────────   │
│         0    50   100   150   200   250   300  케이스 수        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 시나리오별 예상 정확도 (최종)

| 시나리오 | 현재 (24개) | Phase 1 후 | Phase 2 후 | Phase 3 후 |
|----------|------------|------------|------------|------------|
| 기존 케이스와 동일 | ~0% | ~0% | ~0% | ~0% |
| 단일 파라미터 보간 | 5-10% | 3-5% | 2-3% | 1-2% |
| **2개 파라미터 조합** | 15-30% | **8-12%** | **5-7%** | **3-5%** |
| **3개 파라미터 조합** | 30%+ | 18-25% | **10-15%** | **6-10%** |
| 범위 외 (Very Low/High) | 불확실 | 20-30% | 12-18% | 8-15% |

### 10.3 신뢰도 등급 변화

```
┌─────────────────────────────────────────────────────────────────┐
│                    신뢰도 등급 변화 예상                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 현재 (24개 케이스):                                             │
│ ├── A (높음): 기존 케이스만                                     │
│ ├── B (중간): 단일 파라미터 보간                                │
│ ├── C (낮음): 2개 파라미터 조합                                 │
│ └── D (매우 낮음): 3개 이상 / 범위 외                           │
│                                                                 │
│ Phase 3 후 (224개 케이스):                                      │
│ ├── A (높음): 기존 케이스 + 단일 파라미터                       │
│ ├── B (중간): 2개 파라미터 조합 → 신뢰 가능                    │
│ ├── C (낮음): 3개 파라미터 조합 → 참고 가능                    │
│ └── D (매우 낮음): 범위 외만 해당                               │
│                                                                 │
│ 핵심 개선:                                                      │
│ • 2개 파라미터 조합이 "신뢰 가능" 수준으로 상승                 │
│ • 전체 파라미터 공간의 ~70%가 신뢰 가능 영역                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.4 투자 대비 효과 분석

```
┌─────────────────────────────────────────────────────────────────┐
│                     ROI (Return on Investment)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 투자:                                                           │
│ • 시뮬레이션 시간: ~200시간                                     │
│ • 인력: 1명 × 10-12주 (데이터 관리, 품질 검증)                  │
│ • 계산 자원: COMSOL 라이선스 + 워크스테이션                     │
│                                                                 │
│ 효과:                                                           │
│ • 정확도: 15-30% → 3-5% (5-10배 개선)                          │
│ • 신뢰 영역: 3% → 70% (20배 확장)                              │
│ • 예측 시간: 수 시간 → 밀리초 (1000배+ 빠름)                   │
│ • 응용: 연구용 → 정량적 의사결정 가능                          │
│                                                                 │
│ 손익분기점:                                                     │
│ • 약 100회 예측 후 시뮬레이션 시간 절약                         │
│ • 파라미터 최적화, 민감도 분석 등에서 즉각적 가치               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 부록: 참고 자료

### A. LHS 샘플 생성 코드 (Python)

```python
"""
림프칩 PINN용 Latin Hypercube Sampling 생성기
"""

import numpy as np
from scipy.stats import qmc
import pandas as pd
import json

def generate_simulation_cases(n_samples=200, seed=42):
    """
    전체 시뮬레이션 케이스 생성
    """

    # 파라미터 정의
    params = {
        'Lp_ve': {'min': 2e-12, 'max': 3.2e-11, 'scale': 'log', 'unit': 'm/(Pa·s)'},
        'K': {'min': 1e-18, 'max': 1e-12, 'scale': 'log', 'unit': 'm²'},
        'P_oncotic': {'min': 2900, 'max': 4100, 'scale': 'linear', 'unit': 'Pa'},
        'sigma_ve': {'min': 0.05, 'max': 0.95, 'scale': 'linear', 'unit': '-'},
        'D_gel': {'min': 5e-12, 'max': 3e-10, 'scale': 'log', 'unit': 'm²/s'},
        'kdecay': {'min': 0, 'max': 1e-4, 'scale': 'log_zero', 'unit': '1/s'},
    }

    param_names = list(params.keys())
    n_params = len(param_names)

    # LHS 샘플 생성
    sampler = qmc.LatinHypercube(d=n_params, seed=seed)
    samples = sampler.random(n=n_samples)

    # 실제 파라미터 값으로 변환
    cases = []
    for i, sample in enumerate(samples):
        case = {'case_id': f'LHS_{i:03d}'}

        for j, (name, config) in enumerate(params.items()):
            s = sample[j]

            if config['scale'] == 'log':
                log_min = np.log10(config['min'])
                log_max = np.log10(config['max'])
                value = 10 ** (log_min + s * (log_max - log_min))
            elif config['scale'] == 'log_zero':
                if s < 0.1:  # 10%는 kdecay=0
                    value = 0
                else:
                    s_adj = (s - 0.1) / 0.9
                    log_min = np.log10(1e-8)
                    log_max = np.log10(config['max'])
                    value = 10 ** (log_min + s_adj * (log_max - log_min))
            else:
                value = config['min'] + s * (config['max'] - config['min'])

            case[name] = value

        cases.append(case)

    return pd.DataFrame(cases), params

# 실행
df, params = generate_simulation_cases(200)
df.to_csv('simulation_cases.csv', index=False)
print(f"생성된 케이스: {len(df)}개")
print(df.head())
```

### B. COMSOL 배치 실행 스크립트 (예시)

```matlab
% COMSOL MATLAB 배치 실행 스크립트
% 파라미터 매트릭스 파일을 읽어 순차적으로 시뮬레이션 실행

param_file = 'simulation_cases.csv';
params = readtable(param_file);

for i = 1:height(params)
    case_id = params.case_id{i};

    % 파라미터 설정
    Lp_ve = params.Lp_ve(i);
    K = params.K(i);
    P_oncotic = params.P_oncotic(i);
    sigma_ve = params.sigma_ve(i);
    D_gel = params.D_gel(i);
    kdecay = params.kdecay(i);

    % 모델 파라미터 업데이트
    model.param.set('Lp_ve', sprintf('%e[m/(Pa*s)]', Lp_ve));
    model.param.set('K', sprintf('%e[m^2]', K));
    model.param.set('P_oncotic', sprintf('%d[Pa]', P_oncotic));
    model.param.set('sigma_ve', sprintf('%f', sigma_ve));
    model.param.set('D_gel', sprintf('%e[m^2/s]', D_gel));
    model.param.set('k_decay', sprintf('%e[1/s]', kdecay));

    % 시뮬레이션 실행
    model.study('std1').run();

    % 결과 추출 및 저장
    output_folder = sprintf('raw/%s', case_id);
    mkdir(output_folder);

    % 구획별 비율 추출
    export_compartment_ratios(model, output_folder);

    % 메타데이터 저장
    save_metadata(case_id, params(i,:), output_folder);

    fprintf('Completed: %s (%d/%d)\n', case_id, i, height(params));
end
```

### C. 데이터 품질 검증 스크립트

```python
"""
시뮬레이션 데이터 품질 검증
"""

import pandas as pd
import numpy as np
from pathlib import Path

def validate_case(case_path):
    """단일 케이스 품질 검증"""

    errors = []
    warnings = []

    # 데이터 로드
    df = pd.read_csv(case_path / 'compartment_ratios.csv')

    # 1. 질량 보존 검사
    total = df['Blood_pct'] + df['Lymph_pct'] + df['ECM_pct'] + df['Decay_pct']
    mass_error = (total - 100).abs().max()
    if mass_error > 1:
        errors.append(f'질량 보존 위반: 최대 오차 {mass_error:.2f}%')

    # 2. 비음수 검사
    for col in ['Blood_pct', 'Lymph_pct', 'ECM_pct', 'Decay_pct']:
        if (df[col] < 0).any():
            errors.append(f'{col}에 음수 값 존재')

    # 3. 시간 연속성 검사
    time_diff = df['time_hour'].diff()
    if (time_diff < 0).any():
        errors.append('시간 역행 감지')

    # 4. 초기 조건 검사
    initial = df.iloc[0]
    if initial['ECM_pct'] < 95:
        warnings.append(f'초기 ECM 비정상: {initial["ECM_pct"]:.1f}%')

    # 5. 72시간 완료 검사
    if df['time_hour'].max() < 71:
        warnings.append(f'시뮬레이션 미완료: {df["time_hour"].max():.1f}h')

    return errors, warnings

# 전체 검증 실행
def validate_all_cases(data_dir):
    data_dir = Path(data_dir)
    results = []

    for case_dir in data_dir.glob('*'):
        if case_dir.is_dir():
            errors, warnings = validate_case(case_dir)
            results.append({
                'case_id': case_dir.name,
                'errors': len(errors),
                'warnings': len(warnings),
                'error_details': errors,
                'warning_details': warnings
            })

    df_results = pd.DataFrame(results)

    # 요약
    print(f"총 케이스: {len(results)}")
    print(f"오류 케이스: {(df_results['errors'] > 0).sum()}")
    print(f"경고 케이스: {(df_results['warnings'] > 0).sum()}")

    return df_results
```

---

*문서 끝*

**작성자**: Claude Code
**검토일**: 2026-01-26
**다음 단계**: Phase 1 시뮬레이션 실행
